        // Ajustar altura del textarea
        function adjustTextareaHeight() {
            messageInput.style.height = 'auto';
            messageInput.style.height = Math.min(messageInput.scrollHeight, 100) + 'px';
        }

        // Event Listeners
        document.addEventListener('DOMContentLoaded', function() {
            // Navegación por pestañas
            navTabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabId = this.dataset.tab;
                    
                    // Actualizar pestañas activas
                    navTabs.forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                    
                    // Actualizar navegación inferior
                    navItems.forEach(item => {
                        if (item.dataset.tab === tabId) {
                            item.classList.add('active');
                        } else {
                            item.classList.remove('active');
                        }
                    });
                    
                    // Mostrar sección correspondiente
                    contentSections.forEach(section => {
                        section.classList.remove('active');
                        if (section.id === tabId) {
                            section.classList.add('active');
                        }
                    });
                });
            });

            // Navegación inferior
            navItems.forEach(item => {
                item.addEventListener('click', function() {
                    const tabId = this.dataset.tab;
                    
                    // Actualizar navegación inferior
                    navItems.forEach(i => i.classList.remove('active'));
                    this.classList.add('active');
                    
                    // Actualizar pestañas superiores
                    navTabs.forEach(tab => {
                        if (tab.dataset.tab === tabId) {
                            tab.classList.add('active');
                        } else {
                            tab.classList.remove('active');
                        }
                    });
                    
                    // Mostrar sección correspondiente
                    contentSections.forEach(section => {
                        section.classList.remove('active');
                        if (section.id === tabId) {
                            section.classList.add('active');
                        }
                    });
                });
            });

            // Envío de mensajes
            sendMessageBtn.addEventListener('click', sendMessage);
            
            messageInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });

            // Ajustar altura del textarea dinámicamente
            messageInput.addEventListener('input', adjustTextareaHeight);

            // Volver del chat
            backFromChat.addEventListener('click', function() {
                chatView.classList.remove('active');
                if (messagesRef) {
                    messagesRef.off();
                }
            });

            // Botones del header
            document.getElementById('searchBtn').addEventListener('click', function() {
                alert('Funcionalidad de búsqueda en desarrollo');
            });

            document.getElementById('menuBtn').addEventListener('click', function() {
                alert('Menú de opciones en desarrollo');
            });

            // Estado personal
            document.querySelector('.my-status').addEventListener('click', function() {
                const statusText = prompt('¿Qué estás pensando?');
                if (statusText && statusText.trim() !== '') {
                    const statusRef = database.ref('status_updates').push();
                    statusRef.set({
                        userId: currentUser.uid,
                        text: statusText,
                        timestamp: firebase.database.ServerValue.TIMESTAMP
                    });
                    alert('Estado actualizado correctamente');
                }
            });

            // Datos de ejemplo inicial
            initializeSampleData();
        });

        // Inicializar datos de ejemplo
        function initializeSampleData() {
            // Verificar si ya existen datos para no duplicar
            database.ref('chats').once('value').then(snapshot => {
                if (!snapshot.exists()) {
                    createSampleChats();
                }
            });

            database.ref('status_updates').once('value').then(snapshot => {
                if (!snapshot.exists()) {
                    createSampleStatusUpdates();
                }
            });
        }

        // Crear chats de ejemplo
        function createSampleChats() {
            const sampleUsers = [
                { id: 'user1', name: 'Ana García' },
                { id: 'user2', name: 'Carlos López' },
                { id: 'user3', name: 'María Rodríguez' },
                { id: 'user4', name: 'David Martínez' }
            ];

            sampleUsers.forEach(user => {
                const chatId = getChatId(currentUser.uid, user.id);
                const messages = [
                    { text: '¡Hola! ¿Cómo estás?', senderId: user.id },
                    { text: '¡Hola! Estoy bien, gracias. ¿Y tú?', senderId: currentUser.uid },
                    { text: 'Todo bien por aquí. ¿Has visto el nuevo proyecto?', senderId: user.id },
                    { text: 'Sí, me parece muy interesante. Tenemos que coordinar una reunión.', senderId: currentUser.uid }
                ];

                messages.forEach((message, index) => {
                    setTimeout(() => {
                        const encryptedText = encryptMessage(message.text, message.senderId === currentUser.uid ? user.id : currentUser.uid);
                        database.ref('chats/' + chatId).push().set({
                            text: encryptedText,
                            senderId: message.senderId,
                            timestamp: Date.now() - (messages.length - index) * 600000 // 10 minutos entre mensajes
                        });
                    }, index * 100);
                });
            });
        }

        // Crear estados de ejemplo
        function createSampleStatusUpdates() {
            const sampleStatuses = [
                { userId: 'user1', text: '¡Día productivo en el trabajo! 💼' },
                { userId: 'user2', text: 'Disfrutando del fin de semana 🌞' },
                { userId: 'user3', text: 'Nuevo proyecto emocionante 🚀' },
                { userId: 'user4', text: 'Viajando por trabajo ✈️' }
            ];

            sampleStatuses.forEach((status, index) => {
                setTimeout(() => {
                    database.ref('status_updates').push().set({
                        userId: status.userId,
                        text: status.text,
                        timestamp: Date.now() - index * 3600000 // 1 hora entre estados
                    });
                }, index * 100);
            });

            // Crear usuarios de ejemplo
            const sampleUsers = {
                user1: { name: 'Ana García', email: 'ana@example.com', createdAt: firebase.database.ServerValue.TIMESTAMP },
                user2: { name: 'Carlos López', email: 'carlos@example.com', createdAt: firebase.database.ServerValue.TIMESTAMP },
                user3: { name: 'María Rodríguez', email: 'maria@example.com', createdAt: firebase.database.ServerValue.TIMESTAMP },
                user4: { name: 'David Martínez', email: 'david@example.com', createdAt: firebase.database.ServerValue.TIMESTAMP }
            };

            Object.keys(sampleUsers).forEach(userId => {
                database.ref('users/' + userId).set(sampleUsers[userId]);
            });
        }

        // Función para cerrar sesión (puedes agregar un botón en el menú)
        function logout() {
            if (currentUser) {
                database.ref('status/' + currentUser.uid).set({
                    state: 'offline',
                    lastChanged: firebase.database.ServerValue.TIMESTAMP
                });
            }
            
            auth.signOut().then(() => {
                window.location.href = 'index.html';
            }).catch(error => {
                console.error('Error al cerrar sesión:', error);
            });
        }

        // Manejar el evento de antes de descargar la página
        window.addEventListener('beforeunload', function() {
            if (currentUser) {
                database.ref('status/' + currentUser.uid).set({
                    state: 'offline',
                    lastChanged: firebase.database.ServerValue.TIMESTAMP
                });
            }
        });

        // Inicializar altura del textarea
        adjustTextareaHeight();
    </script>
</body>
</html>